åº”ç”¨å¡é¡¿ç›‘å¬

å¡é¡¿æ£€æµ‹ Blockcanary
å†…å­˜æ³„éœ² leakcanary


# **BlockCanary**

åœ°å€
https://github.com/markzhai/AndroidPerformanceMonitor
ä½¿ç”¨æ–¹æ³•
https://github.com/markzhai/AndroidPerformanceMonitor/blob/master/README_CN.md

é¡¹ç›®æ¯”è¾ƒæ—©ï¼Œæœ€å¥½ä½¿ç”¨æ–¹æ³•æ˜¯æ‹‰å‡ºæºç ï¼Œå¯¼å…¥åœ¨é¡¹ç›®é‡Œé¢ä½¿ç”¨
blockcanary-analyzer
blockcanary-android

```java
 public class AppBlockCanaryContext extends BlockCanaryContext {
    ......
    /**
     * å¯ä»¥æ ¹æ®è®¾å¤‡ä¸åŒæƒ…å†µé…ç½®ä¸åŒçš„é˜€å€¼ï¼Œè·‘åˆ¤æ–­å¡é¡¿æ—¶é—´
     */
    public int provideBlockThreshold() {
        return 800;
    }
    ......
    /**
     * æ–‡ä»¶ä¿å­˜è·¯å¾„
     */
    public String providePath() {
        return "/blockcanary/";
    }
    ......
 }
```

å¼‚å¸¸ä¿å­˜æ–‡ä»¶ä¿¡æ¯

ä½ç½®ï¼š/sdcard/blockcanary/

æ–‡ä»¶ä¿¡æ¯å¦‚ä¸‹

![image-20211026144932784](https://gitee.com/ZeTing/UploadImg/raw/main/img/image-20211026144932784.png)

ç°åœ¨è®¾å¤‡å·²ç»åŸºæœ¬è·å–ä¸åˆ°é‡Œé¢çš„cpu ä¿¡æ¯



æ¶ˆæ¯é€šçŸ¥åœ¨android 8.0å·²ç»å¼¹ä¸å‡ºæ¥æ·»åŠ æ–°çš„æ¶ˆæ¯å·¥å…· NotificationUtils
NotificationUtilsä½¿ç”¨åœ°å€  blockcanary-android->com.github.moduth.blockcanary.DisplayService.java

```java
final class DisplayService implements BlockInterceptor {
  ......

    @Override
    public void onBlock(Context context, BlockInfo blockInfo) {
        Log.i("ZZT", "------- 3 ---------");
        Intent intent = new Intent(context, DisplayActivity.class);
        intent.putExtra("show_latest", blockInfo.timeStart);
        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TOP);
        PendingIntent pendingIntent = PendingIntent.getActivity(context, 1, intent, FLAG_UPDATE_CURRENT);
        String contentTitle = context.getString(R.string.block_canary_class_has_blocked, blockInfo.timeStart);
        String contentText = context.getString(R.string.block_canary_notification_message);
//        show(context, contentTitle, contentText, pendingIntent);
        // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
        int requestId = (int) System.currentTimeMillis();
        NotificationUtils.getInstance(context).showNotification(contentTitle, contentText, "1", "ZZT", requestId, R.drawable.block_canary_icon, null, pendingIntent);
    }

  ......
}
```







## NotificationUtils ä»£ç 

```java
package com.github.moduth.blockcanary;

import android.app.AppOpsManager;
import android.app.Application;
import android.app.Notification;
import android.app.NotificationChannel;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.app.Service;
import android.content.Context;
import android.content.pm.ApplicationInfo;
import android.graphics.Bitmap;
import android.graphics.Color;
import android.os.Build;

import androidx.annotation.RequiresApi;
import androidx.core.app.NotificationCompat;

import java.lang.reflect.Field;
import java.lang.reflect.Method;

/**
 * @author: zeting
 * @date: 2021/10/9
 */
public class NotificationUtils {
    private static NotificationUtils mInstance;
    /**
     * é€šçŸ¥æ ç®¡ç†å™¨
     */
    private NotificationManager manager;
    /**
     * é€šçŸ¥æ é¢‘é“è®¾ç½®
     */
    private NotificationChannel notificationChannel;
    /**
     * é€šçŸ¥æ„é€ å™¨
     * åœ¨ä½¿ç”¨æœ€æ–°é€šçŸ¥ API åŠŸèƒ½çš„åŒæ—¶ä»ç„¶æ”¯æŒæ—§ç‰ˆè®¾å¤‡ï¼Œä¸éœ€è¦æ‚¨ç¼–å†™ä»£ç æ£€æŸ¥Apiçº§åˆ«ã€‚
     * éœ€è¦æ³¨æ„è°ƒç”¨æŸä¸ªæ–¹æ³•çš„æ—¶å€™ä¸èƒ½ä¿ä½œæ‰€æœ‰è®¾å¤‡éƒ½æœ‰è¿™ä¸ªåŠŸèƒ½ï¼Œå¯èƒ½å‡ºç°ç©ºæ“ä½œã€‚æ¯”å¦‚addActionåªä¼šåœ¨Api 16ä»¥ä¸Šç”Ÿæ•ˆã€‚
     */
    private NotificationCompat.Builder builder;
    private Context mContext;


    public NotificationUtils(Context con) {
        this.mContext = con;
        //è·å–NotificationManagerå¯¹è±¡
        manager = (NotificationManager) con.getSystemService(Service.NOTIFICATION_SERVICE);
    }

    /**
     * å•ä¸€å®ä¾‹
     */
    public static NotificationUtils getInstance(Context con) {
        if (mInstance == null) {
            mInstance = new NotificationUtils(con);
        }
        return mInstance;
    }

    /**
     * @param title         é€šçŸ¥æ ‡é¢˜
     * @param msg           é€šçŸ¥æ¶ˆæ¯
     * @param channelId     æ¸ é“id
     * @param channelName   æ¸ é“å
     * @param requestId     åŒºåˆ†ä¸åŒçš„é€šçŸ¥ï¼Œè¿™ä¸ªidç”¨äºæ›´æ–°(ä¹Ÿå¯ä»¥å«è¦†ç›–)å’Œç§»é™¤æŸä¸ªé€šçŸ¥
     *                      ä¸€ä¸ªç‹¬ç‰¹çš„Integerï¼Œæ¯”å¦‚ä½¿ç”¨ç³»ç»Ÿæ—¶é—´{int requestId = (int) System.currentTimeMillis();}
     * @param smallIcon     å°å›¾æ ‡
     * @param largeIcon     å¤§å›¾æ ‡
     * @param pendingIntent æŒ‡å®šæ„å›¾å’Œæ‰§è¡Œç›®æ ‡åŠ¨ä½œçš„Intentï¼Œå¾€å¾€ç”¨äºé€šçŸ¥ç‚¹å‡»è·³è½¬
     */

    public void showNotification(String title, String msg, String channelId, String channelName, int requestId, int smallIcon, Bitmap largeIcon, PendingIntent pendingIntent) {

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            //sdk26ä»¥ä¸Šï¼ˆ8.0ï¼‰éœ€è¦æŒ‡å®šé€šé“
            notificationChannel = new NotificationChannel(channelId, channelName, NotificationManager.IMPORTANCE_HIGH);
            //è®¾ç½®å¯ä»¥ç»•è¿‡è¯·å‹¿æ‰“æ‰°æ¨¡å¼
            notificationChannel.setBypassDnd(true);
            //å¯å¦ç»•è¿‡è¯·å‹¿æ‰“æ‰°æ¨¡å¼
            notificationChannel.canBypassDnd();
            //é”å±æ˜¾ç¤ºé€šçŸ¥
            notificationChannel.setLockscreenVisibility(Notification.VISIBILITY_SECRET);
            //æ˜¯å¦ä¼šé—ªå…‰
            notificationChannel.shouldShowLights();
            //é—ªå…‰
            notificationChannel.enableLights(false);
            //æŒ‡å®šé—ªå…‰æ—¶çš„ç¯å…‰é¢œè‰²ï¼Œä½ç‰ˆæœ¬åœ¨builderä¸Šé€šè¿‡setLightsæ–¹æ³•è®¾ç½®{builder.setLights(Color.GREEN, 1000, 1000);}
            notificationChannel.setLightColor(Color.RED);
            //æ­¤é€šé“æ¡Œé¢launcheræ¶ˆæ¯è§’æ ‡ä¸æ˜¾ç¤º
            notificationChannel.setShowBadge(false);
            //æ˜¯å¦å…è®¸éœ‡åŠ¨
            notificationChannel.enableVibration(false);
            //éœ‡åŠ¨æ¨¡å¼ï¼Œç¬¬ä¸€æ¬¡100msï¼Œç¬¬äºŒæ¬¡100msï¼Œç¬¬ä¸‰æ¬¡200msï¼Œä½ç‰ˆæœ¬åœ¨Notification.Builderä¸Šè®¾ç½®{builder.setVibrate(new long[]{200, 1000});}
            notificationChannel.setVibrationPattern(new long[]{100, 100, 200});
            //è·å–ç³»ç»Ÿé€šçŸ¥å“é“ƒå£°éŸ³çš„é…ç½®
            notificationChannel.getAudioAttributes();
            //è·å–é€šçŸ¥æ¸ é“ç»„
            notificationChannel.getGroup();
            /**
             * å…ˆå»ºä¸€ä¸ªæ¸ é“
             */
            manager.createNotificationChannel(notificationChannel);
            builder = new NotificationCompat.Builder(mContext, channelId); //å¿…é¡»æ·»åŠ ï¼ˆAndroid 8.0ï¼‰ ã€å”¯ä¸€æ ‡è¯†ã€‘
            //è®¾ç½®æ ‡é¢˜
            builder.setContentTitle(title);
            //è®¾ç½®æ–‡æœ¬
            builder.setContentText(msg);
            builder.setSmallIcon(smallIcon, 10000);// å¿…é¡»æ·»åŠ ï¼ˆAndroid 8.0ï¼‰
            builder.setLargeIcon(largeIcon);
            builder.setContentIntent(pendingIntent);
            //ç‚¹å‡»é€šçŸ¥ååè‡ªåŠ¨å–æ¶ˆ
            builder.setAutoCancel(true);
        } else {
            //channelIdä¼ ä¸ªnullå³å¯ï¼Œæ—§ç‰ˆæœ¬ä¼šå¿½ç•¥
            builder = new NotificationCompat.Builder(mContext, null);
            builder.setContentIntent(pendingIntent);
            //è®¾ç½®æ ‡é¢˜
            builder.setContentTitle(title);
            //è®¾ç½®æ–‡æœ¬
            builder.setContentText(msg);
            builder.setSmallIcon(smallIcon, 10000);
            builder.setLargeIcon(largeIcon);
            //æŸ¥çœ‹åè‡ªåŠ¨å–æ¶ˆ
            builder.setAutoCancel(true);
            //æ¶ˆæ¯æç¤ºæ¨¡å¼
            builder.setDefaults(Notification.DEFAULT_LIGHTS | Notification.DEFAULT_SOUND);
            //è®¾ç½®éœ‡åŠ¨è§„å¾‹ï¼Œï¼ˆç¬¬ä¸€ä¸ªå‚æ•°: æŒ¯åŠ¨å‰ç­‰å¾…çš„æ—¶é—´ï¼Œç¬¬äºŒä¸ªå‚æ•°ï¼š ç¬¬ä¸€æ¬¡æŒ¯åŠ¨çš„æ—¶é•¿ã€ä»¥æ­¤ç±»æ¨  ï¼‰
            builder.setVibrate(new long[]{200, 1000});
            //è®¾ç½®ç¯
            builder.setLights(Color.GREEN, 1000, 1000);
            //è®¾ç½®é€šçŸ¥ä¼˜å…ˆçº§,é»˜è®¤æ˜¯PRIORITY_DEFAULTï¼ˆAndroid 7.1åŠä»¥ä¸‹éœ€è¦è®¾ç½®ï¼Œ8.0åŠä»¥ä¸Šåœ¨åˆ›å»ºæ¸ é“çš„æ—¶å€™æœ‰æŒ‡å®šæ¸ é“é‡è¦æ€§ï¼‰
            builder.setPriority(NotificationCompat.PRIORITY_HIGH);
            //è®¾ç½®å‘é€åˆ°è¾…åŠ©åŠŸèƒ½æœåŠ¡çš„â€œ tickerâ€æ–‡æœ¬ï¼›åœ¨LOLLIPOPä¹‹å‰ï¼Œç¬¬ä¸€æ¬¡åˆ°è¾¾é€šçŸ¥æ—¶åœ¨çŠ¶æ€æ æ˜¾ç¤ºçš„æ–‡æœ¬
            /*builder.setTicker("ä½ æ”¶åˆ°ä¸€æ¡æ–°é€šçŸ¥");*/
            //ä»€ä¹ˆæ—¶å€™å‘å‡ºé€šçŸ¥
            /*builder.setWhen(SystemClock.currentThreadTimeMillis());*/
            //æ·»åŠ æŒ‰é’®ä»¥åŠæŒ‰é’®ç‚¹å‡»æ„å›¾ï¼ˆApiçº§åˆ«16 JELLY_BEANå¼€å§‹æ”¯æŒæ­¤æ–¹æ³•ï¼‰
            /*builder.addAction(R.drawable.ic_xx,"",xxIntent);*/
        }
        //å‘é€é€šçŸ¥
        manager.notify(requestId, builder.build());
    }

    /**
     * é€šé“é€‚é…
     *
     * @notice è°ƒç”¨æ—¶æœºå°½å¯èƒ½æ—©ï¼Œæ¯”å¦‚åœ¨å„æ¸ é“sdkåˆå§‹åŒ–æˆåŠŸä¹‹å‰å°±åˆ›å»ºå…¶å¯¹åº”çš„é€šé“ï¼Œæ‰èƒ½æ­£å¸¸æ¥æ”¶æ¶ˆæ¯
     */
    @RequiresApi(Build.VERSION_CODES.O)
    public void initNotificationChannel(String id, String name) {
        //8.0é€šé“é€‚é…
        NotificationChannel channel = new NotificationChannel(id, name, NotificationManager.IMPORTANCE_HIGH);
        NotificationManager notificationManager = (NotificationManager) mContext.getSystemService(Service.NOTIFICATION_SERVICE);
        //åˆ›å»ºå¥½é€šé“åï¼Œé€šè¿‡ä»£ç createNotificationChannelä»…ä»…åªèƒ½æ›´æ–°å…¶name/descriptionä»¥åŠå¯¹importanceè¿›è¡Œé™çº§ï¼Œå…¶ä½™é…ç½®å‡æ— æ³•æ›´æ–°ã€‚
        //åå¤è°ƒç”¨createNotificationChannelæ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºåˆ›å»ºç°æœ‰é€šçŸ¥æ¸ é“ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œã€‚
        notificationManager.createNotificationChannel(channel);
    }

    /**
     * åº”ç”¨æ˜¯å¦å…è®¸é€šçŸ¥
     *
     * @param context
     * @return
     */
    @RequiresApi(api = Build.VERSION_CODES.KITKAT)
    public boolean isNotificationEnabled(Context context) {

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            //8.0æ‰‹æœºä»¥ä¸Š
            if (((NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE)).getImportance() == NotificationManager.IMPORTANCE_NONE) {
                return false;
            }
        }

        String CHECK_OP_NO_THROW = "checkOpNoThrow";
        String OP_POST_NOTIFICATION = "OP_POST_NOTIFICATION";

        AppOpsManager mAppOps = (AppOpsManager) context.getSystemService(Context.APP_OPS_SERVICE);
        ApplicationInfo appInfo = context.getApplicationInfo();
        String pkg = context.getApplicationContext().getPackageName();
        int uid = appInfo.uid;

        Class appOpsClass = null;

        try {
            appOpsClass = Class.forName(AppOpsManager.class.getName());
            Method checkOpNoThrowMethod = appOpsClass.getMethod(CHECK_OP_NO_THROW, Integer.TYPE, Integer.TYPE, String.class);
            Field opPostNotificationValue = appOpsClass.getDeclaredField(OP_POST_NOTIFICATION);

            int value = (Integer) opPostNotificationValue.get(Integer.class);
            return ((Integer) checkOpNoThrowMethod.invoke(mAppOps, value, uid, pkg) == AppOpsManager.MODE_ALLOWED);

        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }
}
```



## BlockCanaryçš„ä¸è¶³

ä¸èƒ½ç›‘å¬ onkeyDown å’Œ onTouch

æµ‹è¯•æ•°æ®

```java
override fun onKeyDown(keyCode: Int, event: KeyEvent?): Boolean {
        if (keyCode == KeyEvent.KEYCODE_BACK) {
            Log.d(AppOptimizationUtil.TAG, "onKeyDown  KeyEvent.KEYCODE_BACK")
            Thread.sleep(4000);
        }
        if (keyCode == KeyEvent.KEYCODE_E) {
            Log.d(AppOptimizationUtil.TAG, "onKeyDown  KeyEvent.KEYCODE_E")
            Thread.sleep(4000);
        }
        return super.onKeyDown(keyCode, event)
    }

   tv_touch.setOnTouchListener(object : View.OnTouchListener {
            override fun onTouch(v: View?, event: MotionEvent?): Boolean {
                when (event?.action) {
                    MotionEvent.ACTION_UP -> {
                        Log.d(AppOptimizationUtil.TAG, "onTouch  MotionEvent.ACTION_UP")
                        Thread.sleep(4000)
                    }
                }
                return true
            }
        })
```

è¿™ä¸ªæ—¶å€™ç‚¹å‡»è¿”å›æŒ‰é’®ï¼Œæˆ–è€…æ˜¯é”®ç›˜ï¼Œä½¿ä¸»çº¿ç¨‹æš‚åœBlockCanaryç›‘å¬ä¸åˆ°å¼‚å¸¸





å…¨å±€æ€§ï¼Œåªèƒ½åœ¨åˆå§‹åŒ–ä¹‹åä½¿ç”¨ï¼Œåˆå§‹åŒ–ä¹‹å‰çš„å¡é¡¿é—®é¢˜æ— æ³•åˆ†æï¼Œæ¯”å¦‚Applicationçš„attachBaseContextå‡½æ•°ã€‚





# seiginonakama/BlockCanaryEx

åœ°å€ï¼š[seiginonakama/BlockCanaryEx: make performance bottleneck detection easily when app blocked (github.com)](https://github.com/seiginonakama/BlockCanaryEx)







# Tencent/matrix

é¡¹ç›®åœ°å€

[Tencent/matrix: Matrix is a plugin style, non-invasive APM system developed by WeChat. (github.com)](https://github.com/Tencent/matrix)

# Matrix for Android

Matrix-android å½“å‰ç›‘æ§èŒƒå›´åŒ…æ‹¬ï¼šåº”ç”¨å®‰è£…åŒ…å¤§å°ï¼Œå¸§ç‡å˜åŒ–ï¼Œå¯åŠ¨è€—æ—¶ï¼Œå¡é¡¿ï¼Œæ…¢æ–¹æ³•ï¼ŒSQLite æ“ä½œä¼˜åŒ–ï¼Œæ–‡ä»¶è¯»å†™ï¼Œå†…å­˜æ³„æ¼ç­‰ç­‰ã€‚

- APK Checker: é’ˆå¯¹ APK å®‰è£…åŒ…çš„åˆ†ææ£€æµ‹å·¥å…·ï¼Œæ ¹æ®ä¸€ç³»åˆ—è®¾å®šå¥½çš„è§„åˆ™ï¼Œæ£€æµ‹ APK æ˜¯å¦å­˜åœ¨ç‰¹å®šçš„é—®é¢˜ï¼Œå¹¶è¾“å‡ºè¾ƒä¸ºè¯¦ç»†çš„æ£€æµ‹ç»“æœæŠ¥å‘Šï¼Œç”¨äºåˆ†ææ’æŸ¥é—®é¢˜ä»¥åŠç‰ˆæœ¬è¿½è¸ª

- Resource Canary: åŸºäº WeakReference çš„ç‰¹æ€§å’Œ [Square Haha](https://github.com/square/haha) åº“å¼€å‘çš„ Activity æ³„æ¼å’Œ Bitmap é‡å¤åˆ›å»ºæ£€æµ‹å·¥å…·

- Trace Canary: ç›‘æ§ANRã€ç•Œé¢æµç•…æ€§ã€å¯åŠ¨è€—æ—¶ã€é¡µé¢åˆ‡æ¢è€—æ—¶ã€æ…¢å‡½æ•°åŠå¡é¡¿ç­‰é—®é¢˜

- SQLite Lint: æŒ‰å®˜æ–¹æœ€ä½³å®è·µè‡ªåŠ¨åŒ–æ£€æµ‹ SQLite è¯­å¥çš„ä½¿ç”¨è´¨é‡

- IO Canary: æ£€æµ‹æ–‡ä»¶ IO é—®é¢˜ï¼ŒåŒ…æ‹¬ï¼šæ–‡ä»¶ IO ç›‘æ§å’Œ Closeable Leak ç›‘æ§

- Battery Canary: ç›‘æ§ App æ´»è·ƒçº¿ç¨‹ï¼ˆå¾…æœºçŠ¶æ€ & å‰å° Loop ç›‘æ§ï¼‰ã€ASM è°ƒç”¨ (WakeLock/Alarm/Gps/Wifi/Bluetooth ç­‰ä¼ æ„Ÿå™¨)ã€ åå°æµé‡ (Wifi/ç§»åŠ¨ç½‘ç»œ)ç­‰ Battery Historian ç»Ÿè®¡ App è€—ç”µçš„æ•°æ®

- MemGuard

  æ£€æµ‹å †å†…å­˜è®¿é—®è¶Šç•Œã€ä½¿ç”¨é‡Šæ”¾åçš„å†…å­˜ã€é‡å¤é‡Šæ”¾ç­‰é—®é¢˜

## ç‰¹æ€§

ä¸å¸¸è§„çš„ APM å·¥å…·ç›¸æ¯”ï¼ŒMatrix æ‹¥æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

#### APK Checker

- å…·æœ‰æ›´å¥½çš„å¯ç”¨æ€§ï¼šJAR åŒ…æ–¹å¼æä¾›ï¼Œæ›´æ–¹ä¾¿åº”ç”¨åˆ°æŒç»­é›†æˆç³»ç»Ÿä¸­ï¼Œä»è€Œè¿½è¸ªå’Œå¯¹æ¯”æ¯ä¸ª APK ç‰ˆæœ¬ä¹‹é—´çš„å˜åŒ–
- æ›´å¤šçš„æ£€æŸ¥åˆ†æåŠŸèƒ½ï¼šé™¤å…·å¤‡ APKAnalyzer çš„åŠŸèƒ½å¤–ï¼Œè¿˜æ”¯æŒç»Ÿè®¡ APK ä¸­åŒ…å«çš„ R ç±»ã€æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªåŠ¨æ€åº“é™æ€é“¾æ¥äº† STL ã€æœç´¢ APK ä¸­åŒ…å«çš„æ— ç”¨èµ„æºï¼Œä»¥åŠæ”¯æŒè‡ªå®šä¹‰æ£€æŸ¥è§„åˆ™ç­‰
- è¾“å‡ºçš„æ£€æŸ¥ç»“æœæ›´åŠ è¯¦å®ï¼šæ”¯æŒå¯è§†åŒ–çš„ HTML æ ¼å¼ï¼Œä¾¿äºåˆ†æå¤„ç†çš„ JSON ï¼Œè‡ªå®šä¹‰è¾“å‡ºç­‰ç­‰

ä½¿ç”¨æ–¹æ³•ï¼š[Matrix Android ApkChecker Â· Tencent/matrix Wiki (github.com)](https://github.com/Tencent/matrix/wiki/Matrix-Android-ApkChecker)

ä¸‹è½½åœ°å€ ï¼šhttps://repo.maven.apache.org/maven2/com/tencent/matrix/matrix-apk-canary/2.0.2/matrix-apk-canary-2.0.2.jar

é˜¿é‡Œé•œåƒï¼šhttps://archiva-maven-storage-prod.oss-cn-beijing.aliyuncs.com/repository/central/com/tencent/matrix/matrix-apk-canary/2.0.2/matrix-apk-canary-2.0.2.jar



1ã€æ‰“åŒ…è¾“å…¥apkæ–‡ä»¶

2ã€é…ç½®ä¿®æ”¹

```java
{
  //ä¿®æ”¹æ‰“åŒ…åçš„apkè·¯å¾„ è¾“å…¥apkæ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤æ–‡ä»¶åä»¥apkç»“å°¾å³å¯ï¼‰
  "--apk": "D:/ZZTAndroid/Work_SF/XTrendSF/AppCommon/build/outputs/apk/_debug/release/XTrendSpeed.apk",
  //ä¿®æ”¹æˆè‡ªå·±çš„æ··æ·†è·¯å¾„ ä»£ç æ··æ·†mappingæ–‡ä»¶è·¯å¾„ ï¼ˆé»˜è®¤æ–‡ä»¶åæ˜¯mapping.txtï¼‰
  "--mappingTxt": "D:/ZZTAndroid/Work_SF/XTrendSF/AppCommon/build/outputs/mapping/_debugRelease/mapping.txt",
  //ä¿®æ”¹æˆè‡ªå·±çš„è¾“å…¥è·¯å¾„ è¾“å‡ºç»“æœæ–‡ä»¶è·¯å¾„ï¼ˆä¸å«åç¼€ï¼Œä¼šæ ¹æ®formatå†³å®šè¾“å‡ºæ–‡ä»¶çš„åç¼€ï¼‰
  "--output": "D:/ZZTAndroid/Work_SF/XTrendSF/APKChecker/apk-checker-result",

    ......

  "--formatConfig": [
    {
      // è¾“å‡ºç»“æœæŒ‰ç…§ç±»å(class)æˆ–è€…åŒ…å(package)æ¥åˆ†ç»„
      "name": "-countMethod",
      "group": [
        {
          "name": "Android System",
          "package": "android"
        },
        {
          "name": "java system",
          "package": "java"
        },
        {
          // ä¿®æ”¹æˆè‡ªå·±çš„åº”ç”¨åŒ…åï¼Œæ–¹ä¾¿åˆ†ç»„ç»Ÿè®¡dexä¸­æ–¹æ³•æ•°
          "name": "com.trade.eight.$",
          "package": "com.trade.eight.$"
        }
      ]
    }
  ],
  "options": [

      ......

    {
      // unusedResources å‘ç°apkä¸­åŒ…å«çš„æ— ç”¨èµ„æº
      "name":"-unusedResources",
      "--rTxt":"D:/ZZTAndroid/Work_SF/XTrendSF/AppCommon/build/intermediates/runtime_symbol_list/_debugRelease/R.txt",
      "--ignoreResources"
      :["R.raw.*",
        "R.style.*",
        "R.attr.*",
        "R.id.*",
        "R.string.ignore_*"
      ]
    },

      ......

  ]
}
```

3ã€æ‰§è¡Œæ–¹æ³•

```java
java -jar matrix-apk-canary-2.0.2.jar --config config.json
```

4ã€ç»“æœåˆ†æ , ä¸‹é¢æ˜¯åˆ—å‡ºè¿™äº›æ˜¯å¯ä»¥ä¼˜åŒ–çš„

â€‹	1. å¤§å›¾ç‰‡åˆ†æ

![image-20211209105447640](https://gitee.com/ZeTing/UploadImg/raw/main/img/image-20211209105447640.png)

	2. é‡å¤æ–‡ä»¶åˆ†æ

![image-20211209105531911](https://gitee.com/ZeTing/UploadImg/raw/main/img/image-20211209105531911.png)

 	3.  æœªå¼•ç”¨resourcesæ–‡ä»¶åˆ†æ

![image-20211209105740516](https://gitee.com/ZeTing/UploadImg/raw/main/img/image-20211209105740516.png)

 	4. æœªå¼•ç”¨assets æ–‡ä»¶åˆ†æ

![image-20211209110057460](https://gitee.com/ZeTing/UploadImg/raw/main/img/image-20211209110057460.png)

â€‹	5. è¶…å¤§æ–‡ä»¶æ’åˆ—

![image-20211209110007202](https://gitee.com/ZeTing/UploadImg/raw/main/img/image-20211209110007202.png)









#### Resource Canary

- åˆ†ç¦»äº†æ£€æµ‹å’Œåˆ†æéƒ¨åˆ†ï¼Œä¾¿äºåœ¨ä¸æ‰“æ–­è‡ªåŠ¨åŒ–æµ‹è¯•çš„å‰æä¸‹æŒç»­è¾“å‡ºåˆ†æåçš„æ£€æµ‹ç»“æœ
- å¯¹æ£€æµ‹éƒ¨åˆ†ç”Ÿæˆçš„ Hprof æ–‡ä»¶è¿›è¡Œäº†è£å‰ªï¼Œç§»é™¤äº†å¤§éƒ¨åˆ†æ— ç”¨æ•°æ®ï¼Œé™ä½äº†ä¼ è¾“ Hprof æ–‡ä»¶çš„å¼€é”€
- å¢åŠ äº†é‡å¤ Bitmap å¯¹è±¡æ£€æµ‹ï¼Œæ–¹ä¾¿é€šè¿‡å‡å°‘å†—ä½™ Bitmap æ•°é‡ï¼Œé™ä½å†…å­˜æ¶ˆè€—

#### Trace Canary

- ç¼–è¯‘æœŸåŠ¨æ€ä¿®æ”¹å­—èŠ‚ç , é«˜æ€§èƒ½è®°å½•æ‰§è¡Œè€—æ—¶ä¸è°ƒç”¨å †æ ˆ
- å‡†ç¡®çš„å®šä½åˆ°å‘ç”Ÿå¡é¡¿çš„å‡½æ•°ï¼Œæä¾›æ‰§è¡Œå †æ ˆã€æ‰§è¡Œè€—æ—¶ã€æ‰§è¡Œæ¬¡æ•°ç­‰ä¿¡æ¯ï¼Œå¸®åŠ©å¿«é€Ÿè§£å†³å¡é¡¿é—®é¢˜
- è‡ªåŠ¨æ¶µç›–å¡é¡¿ã€å¯åŠ¨è€—æ—¶ã€é¡µé¢åˆ‡æ¢ã€æ…¢å‡½æ•°æ£€æµ‹ç­‰å¤šä¸ªæµç•…æ€§æŒ‡æ ‡
- å‡†ç¡®ç›‘æ§ANRï¼Œå¹¶ä¸”èƒ½å¤Ÿé«˜å…¼å®¹æ€§å’Œç¨³å®šæ€§åœ°ä¿å­˜ç³»ç»Ÿäº§ç”Ÿçš„ANR Traceæ–‡ä»¶



ä½¿ç”¨æ–¹æ³•

1. åœ¨ä½ é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ gradle.properties ä¸­é…ç½®è¦ä¾èµ–çš„ Matrix ç‰ˆæœ¬å·ï¼Œå¦‚ï¼š

```java
  MATRIX_VERSION=2.0.2
```

1. åœ¨ä½ é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ build.gradle æ–‡ä»¶æ·»åŠ  Matrix ä¾èµ–ï¼Œå¦‚ï¼š

```java
  dependencies {
      classpath ("com.tencent.matrix:matrix-gradle-plugin:${MATRIX_VERSION}")
  }
```

1. æ¥ç€ï¼Œåœ¨ app/build.gradle æ–‡ä»¶ä¸­æ·»åŠ  Matrix å„æ¨¡å—çš„ä¾èµ–ï¼Œå¦‚ï¼š

```java
  dependencies {
implementation "com.tencent.matrix:matrix-android-lib:${MATRIX_VERSION}"
implementation "com.tencent.matrix:matrix-android-commons:${MATRIX_VERSION}"
implementation "com.tencent.matrix:matrix-trace-canary:${MATRIX_VERSION}"
  }

  apply plugin: 'com.tencent.matrix-plugin'
  matrix {
    trace {
        enable = true	//if you don't want to use trace canary, set false
         println "Monitor project.projectDir:${project.projectDir}"
        baseMethodMapFile = "${project.projectDir}/matrixTrace/methodMapping.txt"
        blackListFile = "${project.projectDir}/matrixTrace/blackMethodList.txt"
    }
  }
```

ç›®å‰ Matrix gradle plugin æ”¯æŒ Android Gradle Plugin 3.5.0/4.0.0/4.1.0ã€‚

1. å®ç° PluginListenerï¼Œæ¥æ”¶ Matrix å¤„ç†åçš„æ•°æ®, å¦‚ï¼š

```java
  public class TestPluginListener extends DefaultPluginListener {
    public static final String TAG = "Matrix.TestPluginListener";
    public TestPluginListener(Context context) {
        super(context);

    }

    @Override
    public void onReportIssue(Issue issue) {
        super.onReportIssue(issue);
        MatrixLog.e(TAG, issue.toString());

        //add your code to process data
    }
}
```

1. å®ç°åŠ¨æ€é…ç½®æ¥å£ï¼Œ å¯ä¿®æ”¹ Matrix å†…éƒ¨å‚æ•°. åœ¨ sample-android ä¸­ æˆ‘ä»¬æœ‰ä¸ªç®€å•çš„åŠ¨æ€æ¥å£å®ä¾‹[DynamicConfigImplDemo.java](https://github.com/Tencent/matrix/blob/master/samples/sample-android/app/src/main/java/sample/tencent/matrix/config/DynamicConfigImplDemo.java), å…¶ä¸­å‚æ•°å¯¹åº”çš„ key ä½äºæ–‡ä»¶ [MatrixEnum](https://github.com/Tencent/matrix/blob/master/samples/sample-android/app/src/main/java/sample/tencent/matrix/config/MatrixEnum.java)ä¸­ï¼Œ æ‘˜æŠ„éƒ¨åˆ†ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
  public class DynamicConfigImplDemo implements IDynamicConfig {
    public DynamicConfigImplDemo() {}

    public boolean isFPSEnable() { return true;}
    public boolean isTraceEnable() { return true; }
    public boolean isMatrixEnable() { return true; }
    public boolean isDumpHprof() {  return false;}

    @Override
    public String get(String key, String defStr) {
        //hook to change default values
    }

    @Override
    public int get(String key, int defInt) {
         //hook to change default values
    }

    @Override
    public long get(String key, long defLong) {
        //hook to change default values
    }

    @Override
    public boolean get(String key, boolean defBool) {
        //hook to change default values
    }

    @Override
    public float get(String key, float defFloat) {
        //hook to change default values
    }
}
```

1. é€‰æ‹©ç¨‹åºå¯åŠ¨çš„ä½ç½®å¯¹ Matrix è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦‚åœ¨ Application çš„ç»§æ‰¿ç±»ä¸­ï¼Œ Init æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š

```java
public void startMatrix(Application application) {
  String[] cpuAbis = Build.SUPPORTED_ABIS;
  Log.d(TAG, "æ”¯æŒçš„ABIS:" + Arrays.toString(cpuAbis));

  Matrix.Builder builder = new Matrix.Builder(application); // build matrix
  builder.pluginListener(new TestPluginListener(this)); // add general pluginListener
  DynamicConfigImplDemo dynamicConfig = new DynamicConfigImplDemo(); // dynamic config

 // Configure trace canary.
 TracePlugin tracePlugin = configureTracePlugin(application, dynamicConfig);
 builder.plugin(tracePlugin);

  //add to matrix               
  builder.plugin(tracePlugin);

  //init matrix
  Matrix.init(builder.build());

  // start plugin
  tracePlugin.start();
}
private TracePlugin configureTracePlugin(Application application, DynamicConfigImplDemo dynamicConfig) {

        boolean fpsEnable = dynamicConfig.isFPSEnable();
        boolean traceEnable = dynamicConfig.isTraceEnable();
        boolean signalAnrTraceEnable = dynamicConfig.isSignalAnrTraceEnable();

        File traceFileDir = new File(application.getApplicationContext().getFilesDir(), "matrix_trace");
        if (!traceFileDir.exists()) {
            if (traceFileDir.mkdirs()) {
                Log.e(TAG, "failed to create traceFileDir");
            }
        }
        Log.d(TAG, "traceFileDir:" + traceFileDir.getAbsolutePath());

        File anrTraceFile = new File(traceFileDir, "anr_trace");
        // path : /data/user/0/sample.tencent.matrix/files/matrix_trace/anr_trace
        File printTraceFile = new File(traceFileDir, "print_trace");
        // path : /data/user/0/sample.tencent.matrix/files/matrix_trace/print_trace

        Log.d(TAG, "anrTraceFile:" + anrTraceFile.getAbsolutePath());
        Log.d(TAG, "printTraceFile:" + printTraceFile.getAbsolutePath());

        TraceConfig traceConfig = new TraceConfig.Builder()
                .dynamicConfig(dynamicConfig)
                .enableFPS(fpsEnable)
                .enableEvilMethodTrace(traceEnable)
                .enableAnrTrace(traceEnable)
                .enableStartup(traceEnable)
                .enableIdleHandlerTrace(traceEnable)
                .enableMainThreadPriorityTrace(true)
                .enableSignalAnrTrace(signalAnrTraceEnable)   

                .anrTracePath(anrTraceFile.getAbsolutePath())
            // é€šè¿‡ SignalAnrTracer.printTrace(); å¯¼å…¥æ—¥å¿—åˆ°æ–‡ä»¶
                .printTracePath(printTraceFile.getAbsolutePath())
                .splashActivities("com.trade.eight.moudle.home.activity.LoadingActivity;")
                .isDebug(true)
                .isDevEnv(false)
                .build();

        return new TracePlugin(traceConfig);
    }
```

è‡³æ­¤ï¼ŒMatrixå°±å·²æˆåŠŸé›†æˆåˆ°ä½ çš„é¡¹ç›®ä¸­



æ—¥å¿—æ‰“å°åˆ†æ

trace(åŒ…æ‹¬å¯åŠ¨ã€æ…¢å‡½æ•°å’Œ FPS ä¸‰ç§)

å…±åŒå­—æ®µï¼š

1. machine: åŒºåˆ†è®¾å¤‡å¥½åçš„å­—æ®µ
2. process: è¿›ç¨‹

å¯åŠ¨æ—¥å¿—åˆ†æ

1. tag: Trace_StartUp
2. scene: å¯¹åº”çš„åœºæ™¯
3. application_createï¼šåº”ç”¨å¯åŠ¨çš„è€—æ—¶
4. first_activity_createï¼šactivity å¯åŠ¨è€—æ—¶
5. stage_between_app_and_activity: ä»‹äºåº”ç”¨å’Œ activity ä¸¤è€…ä¹‹é—´çš„è€—æ—¶
6. splash_activity_durationï¼Œæ¬¢è¿é¡µè€—æ—¶
7. startup_duration å¯åŠ¨æ€»è€—æ—¶
8. is_warm_start_up: æ˜¯å¦æ˜¯è½¯å¯åŠ¨,å€¼èŒƒå›´: true å’Œ false
9. application_create_sceneï¼šå¯åŠ¨çš„åœºæ™¯
   - 100 ï¼ˆactivityæ‹‰èµ·çš„ï¼‰
   - 114ï¼ˆserviceæ‹‰èµ·çš„ï¼‰
   - 113 ï¼ˆreceiveræ‹‰èµ·çš„ï¼‰
   - -100 ï¼ˆæœªçŸ¥ï¼Œæ¯”å¦‚contentproviderï¼‰

```java
Monitor.ParseIssueUtil: ISSUE Time Stamp: 2021 å¹´ 12 æœˆ 09 æ—¥ 14:53:01:444
    ISSUE TAG: Trace_StartUp

    ISSUE Content:
    			machine : MIDDLE
    			cpu_app : 0.0
    			mem : 3972190208
    			mem_free : 1551252
    			application_create : 0
    			application_create_scene : 100
    			first_activity_create : 0
    			startup_duration : 179
    			is_warm_start_up : true
    			tag : Trace_StartUp
    			process : com.rynatsa.xtrendspeed_debug
    			time : 1639032781444
```



FPSå¸§ç‡åˆ†æ

å¸§ç‡è¿™è¾¹éœ€è¦ç»Ÿè®¡æ•´ä½“å¸§ç‡ï¼Œå·²ç»æŒ‰åœºæ™¯ç»Ÿè®¡å¸§ç‡æƒ…å†µ

1. tag: Trace_FPS
2. sceneï¼šå¸§ç‡å¯¹åº”çš„åœºæ™¯
3. dropLevelï¼šè¡¡é‡å¸§ç‡æ‰å¸§çš„æ°´å¹³
4. dropSumï¼šæ€»å…±æ‰å¸§çš„æ€»æ—¶é•¿
5. fps: å¸§ç‡

```java

Monitor.ParseIssueUtil: ISSUE Time Stamp: 2021 å¹´ 12 æœˆ 09 æ—¥ 14:53:31:570
    ISSUE TAG: Trace_FPS

    ISSUE Content:
    			machine : MIDDLE
    			cpu_app : 0.0
    			mem : 3972190208
    			mem_free : 1542424
    			scene : com.trade.eight.moudle.home.activity.MainActivity
    			dropLevel : {"DROPPED_FROZEN":0,"DROPPED_HIGH":2,"DROPPED_MIDDLE":3,"DROPPED_NORMAL":15,"DROPPED_BEST":485}
    			dropSum : {"DROPPED_FROZEN":0,"DROPPED_HIGH":61,"DROPPED_MIDDLE":42,"DROPPED_NORMAL":77,"DROPPED_BEST":54}
    			fps : 42.06930923461914
    			tag : Trace_FPS
    			process : com.rynatsa.xtrendspeed_debug
    			time : 1639032811570

```



æ–¹æ³•æ…¢è§£æ

å¯¹äºstackéœ€è¦é€šè¿‡method_mappingæ–‡ä»¶è§£æå †æ ˆï¼Œmappingæ–‡ä»¶åœ¨ä¸Šä¼ å®‰è£…åŒ…çš„æ—¶å€™éœ€è¦ä¸€èµ·ä¸Šä¼ ã€‚ ç‰¹æ®Šå­—æ®µå¦‚ä¸‹ï¼š

1. tag: Trace_EvilMethod
2. detailï¼Œå…·ä½“çš„è€—æ—¶åœºæ™¯
   a. NORMAL, æ™®é€šæ…¢å‡½æ•°åœºæ™¯
   b. ENTER, Activityè¿›å…¥åœºæ™¯
   c. ANR, anrè¶…æ—¶åœºæ™¯
   d. FULL, æ»¡bufferåœºæ™¯ e. STARTUP, å¯åŠ¨è€—æ—¶åœºæ™¯
3. cost: è€—æ—¶
4. stack: å †æ ˆ
5. stackKey: å®¢æˆ·ç«¯æå–çš„ keyï¼Œç”¨æ¥æ ‡è¯† issue çš„å”¯ä¸€æ€§

å¦‚æœ detail == ENTER, ä¼šå¢åŠ viewInfoå­—æ®µ, åŒ…æ‹¬ä¸€ä¸‹ä¸‰ä¸ªå±æ€§ï¼š

1. viewDeep: view çš„æ·±åº¦ï¼Œæ˜¯ä¸ªæ•´æ•°
2. viewCount: view çš„æ•°é‡ï¼Œæ˜¯ä¸ªæ•´æ•°
3. activity: activity çš„ name

å¦‚æœ detail == STARTUP, ä¼šå¢åŠ subType å­—æ®µï¼Œé»˜è®¤å€¼-1

- subType=1ï¼Œä»£è¡¨applicationåˆå§‹åŒ–è¿‡ç¨‹çš„å †æ ˆ
- subType=2ï¼Œä»£è¡¨å¯åŠ¨ç¬¬ä¸€ä¸ªç•Œé¢åˆå§‹åŒ–è¿‡ç¨‹çš„å †æ ˆ

```java
Monitor.ParseIssueUtil: ISSUE Time Stamp: 2021 å¹´ 12 æœˆ 09 æ—¥ 15:21:47:831
    ISSUE TAG: Trace_EvilMethod
    ISSUE KEY: 105406017692249

    ISSUE Content:
    			machine : MIDDLE
    			cpu_app : 0.0
    			mem : 3972190208
    			mem_free : 1571224
    			detail : ANR
    			cost : 5003
    			stackKey : 185|
    			scene : sample.tencent.matrix.trace.TestTraceMainActivity
    			stack : 0,1048574,1,5003
    1,164,1,5003
    2,170,1,5003
    3,173,1,380
    4,174,1,157
    5,175,1,16
    5,176,1,16
    5,177,1,20
    4,179,1,21
    3,180,1,57
    4,181,1,22
    4,182,1,5
    4,184,1,10
    3,185,1,4566

    			threadStack :  
        at android.os.SystemClock:sleep(122)
        at sample.tencent.matrix.trace.TestTraceMainActivity:L(204)
        at sample.tencent.matrix.trace.TestTraceMainActivity:A(150)
        at sample.tencent.matrix.trace.TestTraceMainActivity:testANR(132)
        at java.lang.reflect.Method:invoke(-2)
        at android.view.View$DeclaredOnClickListener:onClick(5363)
        at android.view.View:performClick(6291)
        at android.view.View$PerformClick:run(24931)
        at android.os.Handler:handleCallback(808)
        at android.os.Handler:dispatchMessage(101)
        at android.os.Looper:loop(166)
        at android.app.ActivityThread:main(7529)

    			processPriority : 10
    			processNice : -10
    			isProcessForeground : true
    			memory : {"dalvik_heap":12326,"native_heap":18188,"vm_size":2748588}
    			tag : Trace_EvilMethod
    			process : sample.tencent.matrix
    			time : 1639034507831
```



IO æ—¥å¿—åˆ†æ

1. tag: io

2. typeï¼Œè€—æ—¶è¿™è¾¹çš„ç±»å‹æœ‰ä¸¤ç§ a. MAIN_THREAD_IO=1, åœ¨ä¸»çº¿ç¨‹IOè¶…è¿‡200ms b. BUFFER_TOO_SMALL=2, é‡å¤è¯»å–åŒä¸€ä¸ªæ–‡ä»¶,åŒä¸€ä¸ªå †æ ˆè¶…è¿‡3æ¬¡ c. REPEAT_IO=3, è¯»å†™æ–‡ä»¶çš„bufferè¿‡å°ï¼Œå³å°äº4k d. CLOSE_LEAK=4, æ–‡ä»¶æ³„æ¼

3. path: æ–‡ä»¶çš„è·¯å¾„

4. size: æ–‡ä»¶çš„å¤§å°

5. cost: è¯»å†™çš„è€—æ—¶

6. stack: è¯»å†™çš„å †æ ˆ

7. op: è¯»å†™çš„æ¬¡æ•°

8. buffer: è¯»å†™æ‰€ç”¨çš„bufferå¤§å°ï¼Œè¦æ±‚å¤§äº4k

9. thread: çº¿ç¨‹å

10. opType: 1ä¸ºè¯»ï¼Œ2ä¸ºå†™

11. opSize: è¯»å†™çš„æ€»å¤§å°

12. repeat:

    a. REPEAT_IO : é‡å¤çš„æ¬¡æ•°

    b. Main_IOï¼š1 - å•æ¬¡æ“ä½œ 2 - è¿ç»­è¯»å†™ 3 -2ç§è¡Œä¸º

```java
Monitor.ParseIssueUtil: ISSUE Time Stamp: 2021 å¹´ 12 æœˆ 09 æ—¥ 17:22:22:987
    ISSUE TAG: io
    ISSUE Content:
    			path : /sdcard/a_long.txt
    			size : 40960000
    			op : 80000
    			buffer : 512
    			cost : 526
    			opType : 2
    			opSize : 40960000
    			thread : main
    			stack : sample.tencent.matrix.io.TestIOActivity.writeLongSth(TestIOActivity.java:129)
    sample.tencent.matrix.io.TestIOActivity.onClick(TestIOActivity.java:99)
    java.lang.reflect.Method.invoke(Native Method)
    android.view.View$DeclaredOnClickListener.onClick(View.java:5363)
    android.view.View.performClick(View.java:6291)
    android.view.View$PerformClick.run(View.java:24931)
    android.app.ActivityThread.main(ActivityThread.java:7529)
    java.lang.reflect.Method.invoke(Native Method)
    com.android.internal.os.Zygote$MethodAndArgsCaller.run(Zygote.java:245)
    com.android.internal.os.ZygoteInit.main(ZygoteInit.java:921)

    			repeat : 0
    			tag : io
    			type : 2
    			process : sample.tencent.matrix
    			time : 1639041742987
```



























#### SQLite Lint

- æ¥å…¥ç®€å•ï¼Œä»£ç æ— ä¾µå…¥
- æ•°æ®é‡æ— å…³ï¼Œå¼€å‘ã€æµ‹è¯•é˜¶æ®µå³å¯å‘ç°SQLiteæ€§èƒ½éšæ‚£
- æ£€æµ‹ç®—æ³•åŸºäºæœ€ä½³å®è·µï¼Œé«˜æ ‡å‡†æŠŠæ§SQLiteè´¨é‡*
- åº•å±‚æ˜¯ C++ å®ç°ï¼Œæ”¯æŒå¤šå¹³å°æ‰©å±•

#### IO Canary

- æ¥å…¥ç®€å•ï¼Œä»£ç æ— ä¾µå…¥
- æ€§èƒ½ã€æ³„æ¼å…¨é¢ç›‘æ§ï¼Œå¯¹ IO è´¨é‡å¿ƒä¸­æœ‰æ•°
- å…¼å®¹åˆ° Android P

#### Battery Canary

- æ¥å…¥ç®€å•ï¼Œå¼€ç®±å³ç”¨
- é¢„ç•™ Base ç±»å’Œ Utility å·¥å…·ä»¥ä¾¿æ‰©å±•ç›‘æ§ç‰¹æ€§

#### Memory Hook

- ä¸€ä¸ªæ£€æµ‹ Android native å†…å­˜æ³„æ¼çš„å·¥å…·
- æ— ä¾µå…¥ï¼ŒåŸºäº PLT-hook([iqiyi/xHook](https://github.com/iqiyi/xHook))ï¼Œæ— éœ€é‡ç¼– native åº“
- é«˜æ€§èƒ½ï¼ŒåŸºäº Wechat-Backtrace è¿›è¡Œå¿«é€Ÿ unwind å †æ ˆï¼Œæ”¯æŒ aarch64 å’Œ armeabi-v7a æ¶æ„

#### Pthread Hook

- ä¸€ä¸ªæ£€æµ‹ Android Java å’Œ native çº¿ç¨‹æ³„æ¼åŠç¼©å‡ native çº¿ç¨‹æ ˆç©ºé—´çš„å·¥å…·
- æ— ä¾µå…¥ï¼ŒåŸºäº PLT-hook([iqiyi/xHook](https://github.com/iqiyi/xHook))ï¼Œæ— éœ€é‡ç¼– native åº“
- é€šè¿‡å¯¹ native çº¿ç¨‹çš„é»˜è®¤æ ˆå¤§å°è¿›è¡Œå‡åŠé™ä½çº¿ç¨‹å¸¦æ¥çš„è™šæ‹Ÿå†…å­˜å¼€é”€ï¼Œåœ¨ 32 ä½ç¯å¢ƒä¸‹å¯ç¼“è§£è™šæ‹Ÿå†…å­˜ä¸è¶³å¯¼è‡´çš„å´©æºƒé—®é¢˜

#### WVPreAllocHook

- ä¸€ä¸ªç”¨äºå®‰å…¨é‡Šæ”¾ WebView é¢„åˆ†é…å†…å­˜ä»¥åœ¨ä¸åŠ è½½ WebView æ—¶èŠ‚çœè™šæ‹Ÿå†…å­˜çš„å·¥å…·ï¼Œåœ¨ 32 ä½ç¯å¢ƒä¸‹å¯ç¼“è§£è™šæ‹Ÿå†…å­˜ä¸è¶³å¯¼è‡´çš„å´©æºƒé—®é¢˜
- æ— ä¾µå…¥ï¼ŒåŸºäº PLT-hook([iqiyi/xHook](https://github.com/iqiyi/xHook))ï¼Œæ— éœ€é‡ç¼– native åº“
- ä½¿ç”¨è¯¥å·¥å…·å WebView ä»å¯æ­£å¸¸å·¥ä½œ

#### MemGuard

- ä¸€ä¸ªåŸºäº GWP-Asan ä¿®æ”¹çš„å †å†…å­˜é—®é¢˜æ£€æµ‹å·¥å…·
- æ— ä¾µå…¥ï¼ŒåŸºäº PLT-hook([iqiyi/xHook](https://github.com/iqiyi/xHook))ï¼Œæ— éœ€é‡ç¼– native åº“
- å¯æ ¹æ®æ­£åˆ™è¡¨è¾¾å¼æŒ‡å®šè¢«æ£€æµ‹çš„ç›®æ ‡åº“
- å¯æ£€æµ‹å †å†…å­˜è®¿é—®è¶Šç•Œã€ä½¿ç”¨é‡Šæ”¾åçš„å†…å­˜å’ŒåŒé‡é‡Šæ”¾ç­‰é—®é¢˜

#### Backtrace Component

- åŸºäº DWARF ä»¥åŠ ARM å¼‚å¸¸å¤„ç†æ•°æ®è¿›è¡Œç®€åŒ–å¹¶ç”Ÿæˆå…¨æ–°çš„ quicken unwind tables æ•°æ®ï¼Œç”¨äºå®ç°å¯å¿«é€Ÿå›æº¯ native è°ƒç”¨æ ˆçš„ backtrace ç»„ä»¶ã€‚å›æº¯é€Ÿåº¦çº¦æ˜¯ libunwindstack çš„ 15x ~ 30x å·¦å³ã€‚



## ä½¿ç”¨æ–¹æ³•

***ç”±äº JCenter æœåŠ¡å°†äº 2022 å¹´ 2 æœˆ 1 æ—¥ä¸‹çº¿ï¼Œæˆ‘ä»¬å·²å°† Matrix æ–°ç‰ˆæœ¬ï¼ˆ>= 0.8.0) maven repo å‘å¸ƒè‡³ MavenCentralã€‚***

1. åœ¨ä½ é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ gradle.properties ä¸­é…ç½®è¦ä¾èµ–çš„ Matrix ç‰ˆæœ¬å·ï¼Œå¦‚ï¼š

```java
  MATRIX_VERSION=2.0.2
```

1. åœ¨ä½ é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ build.gradle æ–‡ä»¶æ·»åŠ  Matrix ä¾èµ–ï¼Œå¦‚ï¼š

```java
  dependencies {
     classpath("com.tencent.matrix:matrix-gradle-plugin:${MATRIX_VERSION}")
  }
```

1. æ¥ç€ï¼Œåœ¨ app/build.gradle æ–‡ä»¶ä¸­æ·»åŠ  Matrix å„æ¨¡å—çš„ä¾èµ–ï¼Œå¦‚ï¼š

```java
dependencies {
implementation "com.tencent.matrix:matrix-android-lib:${MATRIX_VERSION}"
implementation "com.tencent.matrix:matrix-android-commons:${MATRIX_VERSION}"
implementation "com.tencent.matrix:matrix-trace-canary:${MATRIX_VERSION}"
implementation "com.tencent.matrix:matrix-resource-canary-android:${MATRIX_VERSION}"
implementation "com.tencent.matrix:matrix-resource-canary-common:${MATRIX_VERSION}"
implementation "com.tencent.matrix:matrix-io-canary:${MATRIX_VERSION}"
implementation "com.tencent.matrix:matrix-sqlite-lint-android-sdk:${MATRIX_VERSION}"
implementation "com.tencent.matrix:matrix-battery-canary:${MATRIX_VERSION}"
implementation "com.tencent.matrix:matrix-hooks:${MATRIX_VERSION}"
}

apply plugin: 'com.tencent.matrix-plugin'
matrix {
    trace {
        enable = true	//if you don't want to use trace canary, set false
        baseMethodMapFile = "${project.buildDir}/matrix_output/Debug.methodmap"
        blackListFile = "${project.projectDir}/matrixTrace/blackMethodList.txt"
    }
}
```





TracePlugin ä¹‹ ä¸ŠæŠ¥å­—æ®µå«ä¹‰

é€šç”¨

```bash
tagï¼šç±»å‹ï¼ŒTrace_StartUpï¼ŒTrace_FPS ç­‰
processï¼šç›‘æµ‹è¿›ç¨‹
typeï¼šç±»å‹ï¼Œç”¨äºåŒºåˆ†åŒä¸€ä¸ªtagä¸åŒç±»å‹çš„ä¸ŠæŠ¥
keyï¼šæ¯ä¸ªTracerä¸åŒ
timeï¼šä¸ŠæŠ¥æ—¶é—´
contentï¼šä¸ŠæŠ¥çš„ä¸»ä½“å†…å®¹

machineï¼šBEST æœºå™¨åˆ†çº§ BEST, HIGH, MIDDLE, LOW, BAD, UN_KNOW;
cpu_appï¼šCPUä½¿ç”¨ç‡
memï¼šæ€»å†…å­˜å¤§å°
mem_freeï¼šå¯ç”¨å†…å­˜å¤§å°
```

## FrameTracer



```bash
sceneï¼šå½“å‰å¯è§çš„activity
dropLevelï¼šè®°å½•å„ä¸ªå¡æ®µçº§åˆ«å‡ºç°çš„æ¬¡æ•°ï¼Œå¡é¡¿çº§åˆ«å¯åˆ†ä¸ºDROPPED_FROZEN,DROPPED_HIGH,DROPPED_MIDDLE,DROPPED_NORMAL,DROPPED_BEST;ä¾‹ï¼š
    "DROPPED_MIDDLE":18ï¼Œè¡¨ç¤ºæ—¶é—´é˜ˆå€¼å†…å…±æœ‰ 18æ­¤æ—¶ DROPPED_MIDDLEçš„æƒ…å†µ
dropSumï¼šè®°å½•å„ä¸ªå¡æ®µçº§åˆ«æ‰å¸§æ€»æ•°ï¼Œä¾‹ï¼š
    "DROPPED_MIDDLE":218, è¡¨ç¤ºæ—¶é—´é˜ˆå€¼å†…å…±æœ‰ 218å¸§æ˜¯ ä½äº DROPPED_MIDDLE
fpsï¼šæ—¶é—´é˜ˆå€¼å†…çš„å¹³å‡å¸§ç‡
dropTaskFrameSumï¼šä¸å¤ªæ¸…æ¥š
```

## StartupTracer



```cpp
tag: Trace_EvilMethod or Trace_StartUp

application_createï¼šï¼ˆApplicationçš„å¯åŠ¨æ—¶é—´ï¼‰ç¬¬ä¸€æ¬¡å¯åŠ¨Activityæˆ–è€…Serviceæˆ–è€…å¹¿æ’­çš„æ—¶é—´ï¼ˆè¿™é‡Œæ²¡æœ‰å†…å®¹æä¾›è€…æ˜¯å› ä¸ºå†…å®¹æä¾›è€…æ˜¯åœ¨Applicationåˆå§‹åŒ–å®Œæˆä¹‹å‰ï¼ŒåŠ è½½å®Œæ¯•çš„ï¼‰ å‡å» Applicationå¼€å§‹å¯åŠ¨æ—¶é—´
application_create_sceneï¼šå¯åŠ¨åœºæ™¯ Activityï¼ˆ159,100ï¼‰ï¼ŒServiceï¼ˆ114ï¼‰ï¼ŒbroadcastReceiverï¼ˆï¼‰113
first_activity_createï¼šï¼ˆé¦–å±å¯åŠ¨æ—¶é—´ï¼‰ç¬¬ä¸€ä¸ªActivity å¯æ“ä½œçš„æ—¶é—´ï¼ˆActivityè·å–ç„¦ç‚¹ï¼‰ å‡å» Applicationå¼€å§‹å¯åŠ¨æ—¶é—´
startup_durationï¼šå¯åŠ¨æ—¶é—´å¯åˆ†ä¸º ï¼š
    * ï¼ˆå†·å¯åŠ¨æ—¶é—´ï¼‰ï¼šä¸»Activityå¯æ“ä½œçš„æ—¶é—´ï¼ˆActivityè·å–ç„¦ç‚¹ï¼‰ å‡å» Applicationå¼€å§‹å¯åŠ¨æ—¶é—´
    * ï¼ˆæš–å¯åŠ¨æ—¶é—´ï¼‰ï¼šæœ€è¿‘ä¸€ä¸ªActivityå¼€å§‹å¯åŠ¨çš„æ—¶é—´ å‡å» è¿™ä¸ªActivityå¯æ“ä½œçš„æ—¶é—´ï¼ˆActivityè·å–ç„¦ç‚¹ï¼‰
is_warm_start_upï¼šæ˜¯å¦æ˜¯æš–å¯åŠ¨

detailï¼šå›ºå®šä¸ºSTARTUP
costï¼šæ€»è€—æ—¶åŒ startup_duration
stackï¼šæ–¹æ³•æ ˆä¿¡æ¯ï¼Œ æ¯ä¸ªitemä¹‹é—´ç”¨â€œ\nâ€éš”å¼€ï¼Œæ¯ä¸ªitemçš„å«ä¹‰ä¸ºï¼Œè°ƒç”¨æ·±åº¦ï¼ŒmethodIdï¼Œè°ƒç”¨æ¬¡æ•°ï¼Œè€—æ—¶
    * æ¯”å¦‚ï¼š0,118,1,5 -> è°ƒç”¨æ·±åº¦ä¸º0ï¼ŒmethodId=118ï¼Œè°ƒç”¨æ¬¡æ•°=1ï¼Œè€—æ—¶5ms
stackKeyï¼šä¸»è¦è€—æ—¶æ–¹æ³• çš„methodId
subTypeï¼š2ï¼šæš–å¯åŠ¨ï¼Œ1ï¼šå†·å¯åŠ¨
```

## EvilMethodTracer



```cpp
tag: Trace_EvilMethod

detailï¼šå›ºå®šä¸ºNORMAL
costï¼šæ€»è€—æ—¶
usageï¼šä¸»çº¿ç¨‹cpuå ç”¨ç‡
sceneï¼šå½“å‰å¯è§Activityåç§°
stackï¼šæ–¹æ³•æ ˆä¿¡æ¯ï¼Œ æ¯ä¸ªitemä¹‹é—´ç”¨â€œ\nâ€éš”å¼€ï¼Œæ¯ä¸ªitemçš„å«ä¹‰ä¸ºï¼Œè°ƒç”¨æ·±åº¦ï¼ŒmethodIdï¼Œè°ƒç”¨æ¬¡æ•°ï¼Œè€—æ—¶
    * æ¯”å¦‚ï¼š0,118,1,5 -> è°ƒç”¨æ·±åº¦ä¸º0ï¼ŒmethodId=118ï¼Œè°ƒç”¨æ¬¡æ•°=1ï¼Œè€—æ—¶5ms
stackKeyï¼šä¸»è¦è€—æ—¶æ–¹æ³• çš„methodId
```

## AnrTracer



```cpp
tag: Trace_EvilMethod
keyï¼štoken(dispatchStartçš„æ—¶é—´)

detailï¼šå›ºå®šä¸ºANR
costï¼šæ€»è€—æ—¶
usageï¼šä¸»çº¿ç¨‹cpuå ç”¨ç‡
sceneï¼šå½“å‰å¯è§Activityåç§°
stackï¼šæ–¹æ³•æ ˆä¿¡æ¯ï¼Œ æ¯ä¸ªitemä¹‹é—´ç”¨â€œ\nâ€éš”å¼€ï¼Œæ¯ä¸ªitemçš„å«ä¹‰ä¸ºï¼Œè°ƒç”¨æ·±åº¦ï¼ŒmethodIdï¼Œè°ƒç”¨æ¬¡æ•°ï¼Œè€—æ—¶
    * æ¯”å¦‚ï¼š0,118,1,5 -> è°ƒç”¨æ·±åº¦ä¸º0ï¼ŒmethodId=118ï¼Œè°ƒç”¨æ¬¡æ•°=1ï¼Œè€—æ—¶5ms
stackKeyï¼šä¸»è¦è€—æ—¶æ–¹æ³• çš„methodId
threadStackï¼šå †æ ˆä¿¡æ¯
processPriorityï¼šåŠ¨æ€çº¿ç¨‹ä¼˜å…ˆçº§
processNiceï¼šï¼ˆé™æ€çº¿ç¨‹ä¼˜å…ˆçº§ï¼‰
isProcessForegroundï¼šæ˜¯å¦æ˜¯åå°çº¿ç¨‹
memoryï¼šå†…å­˜æƒ…å†µåŒ…å«å¦‚ä¸‹ä¸‰éƒ¨åˆ†
    dalvik_heapï¼šdalvikå·²ä½¿ç”¨å†…å­˜å¤§å°ï¼ˆKBï¼‰
    native_heapï¼šnativeå·²ä½¿ç”¨å†…å­˜å¤§å°ï¼ˆKBï¼‰
    vm_sizeï¼šè™šæ‹Ÿå†…å­˜æ€»å¤§å°
```









# JakeWharton/hugo

é€šè¿‡æ·»åŠ æ³¨è§£å¯ä»¥çŸ¥é“æ¯ä¸ªæ–¹æ³•çš„å…·ä½“æ‰§è¡Œæ—¶é—´

åœ°å€ï¼šhttps://github.com/JakeWharton/hugo





# xCrash

[iqiyi/xCrash: ğŸ”¥ xCrash provides the Android app with the ability to capture java crash, native crash and ANR. No root permission or any system permissions are required. (github.com)](https://github.com/iqiyi/xCrash)



# DoKit

[didi/DoraemonKit: ä¸€æ¬¾é¢å‘æ³›å‰ç«¯äº§å“ç ”å‘å…¨ç”Ÿå‘½å‘¨æœŸçš„æ•ˆç‡å¹³å°ã€‚ (github.com)](https://github.com/didi/DoraemonKit)



dokit ä¸­æœ‰åŸ‹ç‚¹çš„å®ç°ï¼Œä¿å­˜è¯·æ±‚åŸ‹ç‚¹ä¸Šä¼ åŸ‹ç‚¹æ•°æ®





# CacheWebView

WebView é€šè¿‡ç½‘ç»œç¼“å­˜æ•°æ®

[yale8848/CacheWebView: Custom implement Android WebView cache, offline website, let cahe config more simple and flexible (github.com)](https://github.com/yale8848/CacheWebView)
